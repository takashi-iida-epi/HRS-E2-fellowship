---
title: "Analysis"
author: "Takashi Iida"
date: today
format: html
html-table-processing: none
---
## Overview

This document creates tables and figures for the manuscript.

## Setup

```{r}
#| label: setup
#| message: false


library(tidyverse)
library(haven)
```

## Load clean data  

```{r}
# data import
# install.packages("haven")


getwd()

base_directory <- "/Users/iidatakashi/Documents/Git/HRS-E2-fellowship/data"

setwd(base_directory)

dat <- read_sas("randhrs1992_2022v1.sas7bdat")

```


## Multiple imputation


```{r}
# install.packages("mice")
library(mice)

# check num of NAs in each variable
colSums(is.na(dat_long |> 
    select(housing_stress_bin, total_recall_z, ser7_z,
            age, income, smoking, comorbidity_index)))

            library(mice)

# dataset for multiple imutation
dat_mi <- dat_long |> 
  select(
    HHIDPN, wave,
    
    # variabels for analysis
    housing_stress_bin,
    total_recall_z, ser7_z,
    age, income, smoking, comorbidity_index,
    
    # Time-invariant
    sex, race_etn, education,
    
    # Auxiliary variables（attritionと相関しやすい）
    # imrc, dlrc,        # components of total_recall_z ->remove(collinear)
    # ser7,              # raw score ->remove(collinear)
    # total_recall,    # raw total recall ->remove(collinear)
    # housing_stress,    # raw housing stress ->remove(collinear)
  )

# remove HHIDPN and wave for imputation
ini <- mice(dat_mi, maxit = 0)
meth <- ini$method
meth["HHIDPN"] <- ""
meth["wave"]   <- ""

# Warning
# ini$loggedEvents
# table(dat_mi$race_etn, useNA = "always")

# remove HHIDPN from predictormatrix
ini  <- mice(dat_mi, maxit = 0)
meth <- ini$method
meth["HHIDPN"] <- ""
meth["wave"]   <- ""

# edit predictormatrix
pred <- ini$predictorMatrix
pred[, "HHIDPN"] <- 0  # remove HHIDPNfrom predictor

imp <- mice(
  dat_mi, 
  method          = meth,
  predictorMatrix = pred,
  m               = 20, 
  seed            = 123, 
  print           = FALSE
)

# 確認
summary(imp)
plot(imp)
```


## Modeling


```{r}
install.packages("fixest")
library(fixest)

# imputed datasetsを取り出してリストに格納
imp_list <- lapply(1:20, function(i) complete(imp, i))

# 各imputed datasetにFEモデルを適用
models_tr <- lapply(imp_list, function(d) {
  feols(total_recall_z ~ housing_stress_bin + age + income + 
                         smoking + comorbidity_index + wave 
        | HHIDPN,
        cluster = ~HHIDPN,
        data = d)
})

models_ser7 <- lapply(imp_list, function(d) {
  feols(ser7_z ~ housing_stress_bin + age + income + 
                 smoking + comorbidity_index + wave 
        | HHIDPN,
        cluster = ~HHIDPN,
        data = d)
})

# Rubin's rulesでpooling
pool_tr   <- pool(models_tr)
pool_ser7 <- pool(models_ser7)

summary(pool_tr, conf.int = TRUE)
summary(pool_ser7)
```


## Plot

### Forest plot

```{r}
ggplot(res_plot, aes(x = estimate, y = outcome, color = outcome)) +
  geom_point(size = 4) +
  geom_errorbarh(aes(xmin = `2.5 %`, xmax = `97.5 %`), 
                 height = 0.15, size = 1) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50") +
  # p値をラベルとして追加
  geom_text(aes(label = paste0("p = ", round(p.value, 3)),
                x = `97.5 %` + 0.005),
            hjust = 0, size = 3.5, color = "gray30") +
  scale_color_manual(values = c("Episodic Memory" = "#E07B6A",
                                "Working Memory"  = "#4AABB8")) +
  labs(
    title = "Effect of Ongoing Housing Stress\non Cognitive Function",
    subtitle = "Fixed Effects Model\nadjusted for age, income, smoking, comorbidity",
    x = "Coefficient (95% CI)",
    y = NULL
  ) +
  expand_limits(x = 0.02) +  # p値表示のスペース確保
  theme_minimal() +
  theme(legend.position = "none",
        plot.title    = element_text(size = 13, face = "bold"),
        plot.subtitle = element_text(size = 10, color = "gray50"),
        axis.text.y   = element_text(size = 12))
```

